name: PR Impact Visualization

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'src/**/*.ts'
      - 'src/**/*.tsx'
      - 'src/**/*.js'
      - 'src/**/*.jsx'

permissions:
  contents: read
  pull-requests: write

jobs:
  visualize-impact:
    name: Visualize PR Impact
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Get changed files
        id: changed-files
        run: |
          CHANGED_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | grep -E '\.(ts|tsx|js|jsx)$' | grep '^src/' || true)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          CHANGED_COUNT=$(echo "$CHANGED_FILES" | grep -v '^$' | wc -l | tr -d ' ')
          echo "count=$CHANGED_COUNT" >> $GITHUB_OUTPUT

      - name: Run impact analysis
        id: impact-analysis
        if: steps.changed-files.outputs.count > 0
        env:
          BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
        run: |
          node scripts/visualize-pr-impact.mjs

      - name: Read impact report
        id: read-report
        if: steps.changed-files.outputs.count > 0
        run: |
          if [ -f pr-impact.md ]; then
            {
              echo 'report<<EOF'
              cat pr-impact.md
              echo 'EOF'
            } >> $GITHUB_OUTPUT

            # Extract summary for AI review
            CHANGED_COUNT="${{ steps.changed-files.outputs.count }}"
            CHANGED_FILES=$(cat pr-impact.md | sed -n '/## ë³€ê²½ëœ íŒŒì¼/,/## ì˜í–¥ë°›ëŠ” íŒŒì¼/p' | grep '^- `' | sed 's/^- `//;s/`$//')
            IMPACTED_FILES=$(cat pr-impact.md | sed -n '/## ì˜í–¥ë°›ëŠ” íŒŒì¼/,$p' | grep '^- `' | sed 's/^- `//;s/`$//')
            IMPACTED_COUNT=$(echo "$IMPACTED_FILES" | grep -v '^$' | wc -l | tr -d ' ')

            {
              echo 'impact_summary<<EOF'
              echo "ë³€ê²½ëœ íŒŒì¼ ìˆ˜: ${CHANGED_COUNT}ê°œ"
              echo "ì˜í–¥ë°›ëŠ” íŒŒì¼ ìˆ˜: ${IMPACTED_COUNT}ê°œ"
              echo ""
              echo "ë³€ê²½ëœ íŒŒì¼:"
              echo "$CHANGED_FILES"
              echo ""
              if [ ! -z "$IMPACTED_FILES" ]; then
                echo "ì˜í–¥ë°›ëŠ” íŒŒì¼:"
                echo "$IMPACTED_FILES"
              fi
              echo 'EOF'
            } >> $GITHUB_OUTPUT
          fi

      - name: Generate AI-powered impact analysis
        if: steps.changed-files.outputs.count > 0 && steps.read-report.outputs.impact_summary != ''
        id: ai-analysis
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          IMPACT_SUMMARY: ${{ steps.read-report.outputs.impact_summary }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "âš ï¸ GEMINI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "ì˜í–¥ ë²”ìœ„ ì‹œê°í™”ë§Œ ì œê³µë©ë‹ˆë‹¤."
            echo "ai_advice=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Create Python script for API call
          cat > /tmp/call_gemini.py << 'PYTHON_SCRIPT'
          import os
          import json
          import urllib.request

          api_key = os.environ['GEMINI_API_KEY']
          impact_summary = os.environ['IMPACT_SUMMARY']
          pr_title = os.environ['PR_TITLE']

          prompt = f"""ë‹¹ì‹ ì€ React/TypeScript í”„ë¡œì íŠ¸ì˜ ì‹œë‹ˆì–´ ê°œë°œìì…ë‹ˆë‹¤.

          ë‹¤ìŒì€ Pull Requestì˜ ì˜í–¥ ë²”ìœ„ ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤:

          {impact_summary}

          PR ì œëª©: {pr_title}

          ìœ„ ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒ ê´€ì ì—ì„œ êµ¬ì²´ì ì¸ ì¡°ì–¸ì„ í•œêµ­ì–´ë¡œ ì œê³µí•´ì£¼ì„¸ìš”:

          ### ğŸ§ª í…ŒìŠ¤íŠ¸ ë²”ìœ„
          ì˜í–¥ë°›ëŠ” íŒŒì¼ë“¤ ì¤‘ íŠ¹íˆ ì£¼ì˜ê¹Šê²Œ í…ŒìŠ¤íŠ¸í•´ì•¼ í•  ì˜ì—­ì„ êµ¬ì²´ì ì¸ íŒŒì¼ëª…ê³¼ í•¨ê»˜ ì„¤ëª…í•´ì£¼ì„¸ìš”.

          ### âš ï¸ ì ì¬ì  ìœ„í—˜
          ë³€ê²½ì´ ë¯¸ì¹  ìˆ˜ ìˆëŠ” ë¶€ì‘ìš©ì´ë‚˜ ë²„ê·¸ ê°€ëŠ¥ì„±ì„ ê²½ê³ í•´ì£¼ì„¸ìš”.

          ### ğŸ”§ ê°œì„  ì œì•ˆ
          ì´ë²ˆ ë³€ê²½ê³¼ í•¨ê»˜ ê°œì„ í•  ìˆ˜ ìˆëŠ” ë¶€ë¶„ì„ ì œì•ˆí•´ì£¼ì„¸ìš”.

          ### ğŸ“ ë¬¸ì„œí™”
          ì—…ë°ì´íŠ¸ê°€ í•„ìš”í•œ ë¬¸ì„œë‚˜ ì£¼ì„ì„ ì–¸ê¸‰í•´ì£¼ì„¸ìš”.

          ê° í•­ëª©ì€ 2-3ë¬¸ì¥ìœ¼ë¡œ ê°„ê²°í•˜ê²Œ ì‘ì„±í•˜ê³ , êµ¬ì²´ì ì¸ íŒŒì¼ëª…ì„ í¬í•¨í•´ì£¼ì„¸ìš”."""

          data = {
              "contents": [{
                  "parts": [{"text": prompt}]
              }],
              "generationConfig": {
                  "temperature": 0.7,
                  "maxOutputTokens": 1024
              }
          }

          url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key={api_key}"
          req = urllib.request.Request(url, json.dumps(data).encode('utf-8'), {'Content-Type': 'application/json'})

          try:
              with urllib.request.urlopen(req) as response:
                  result = json.loads(response.read().decode('utf-8'))
                  if 'candidates' in result and len(result['candidates']) > 0:
                      print(result['candidates'][0]['content']['parts'][0]['text'])
                  else:
                      print("")
          except Exception as e:
              print(f"Error: {e}", file=os.sys.stderr)
              print("")
          PYTHON_SCRIPT

          # Run Python script
          ADVICE=$(python3 /tmp/call_gemini.py 2>&1)

          if [ -z "$ADVICE" ] || [[ "$ADVICE" == Error:* ]]; then
            echo "âŒ AI ì¡°ì–¸ ìƒì„± ì‹¤íŒ¨: $ADVICE"
            echo "ai_advice=" >> $GITHUB_OUTPUT
          else
            echo "âœ… AI ì¡°ì–¸ ìƒì„± ì„±ê³µ"
            {
              echo 'ai_advice<<EOF'
              echo "$ADVICE"
              echo 'EOF'
            } >> $GITHUB_OUTPUT
          fi

          rm -f /tmp/call_gemini.py

      - name: Find existing comment
        if: steps.changed-files.outputs.count > 0
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: 'PR ì˜í–¥ ë²”ìœ„ ë¶„ì„'

      - name: Create or update comment
        if: steps.changed-files.outputs.count > 0 && steps.read-report.outputs.report != ''
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: |
            ${{ steps.read-report.outputs.report }}
            ${{ steps.ai-analysis.outputs.ai_advice != '' && format('
            ---

            ## ğŸ¤– AI ê¸°ë°˜ ì˜í–¥ ë¶„ì„ ë° ì¡°ì–¸

            {0}

            *ì´ ì¡°ì–¸ì€ Gemini APIë¥¼ í†µí•´ ì˜í–¥ ë²”ìœ„ ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*', steps.ai-analysis.outputs.ai_advice) || '' }}

      - name: No changes detected
        if: steps.changed-files.outputs.count == 0
        run: |
          echo "No TypeScript/JavaScript files changed in src directory. Skipping impact analysis."
