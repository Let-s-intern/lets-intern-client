name: PR Impact Visualization

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'src/**/*.ts'
      - 'src/**/*.tsx'
      - 'src/**/*.js'
      - 'src/**/*.jsx'

permissions:
  contents: read
  pull-requests: write

jobs:
  visualize-impact:
    name: Visualize PR Impact
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Get changed files
        id: changed-files
        run: |
          CHANGED_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | grep -E '\.(ts|tsx|js|jsx)$' | grep '^src/' || true)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          CHANGED_COUNT=$(echo "$CHANGED_FILES" | grep -v '^$' | wc -l | tr -d ' ')
          echo "count=$CHANGED_COUNT" >> $GITHUB_OUTPUT

      - name: Run impact analysis
        id: impact-analysis
        if: steps.changed-files.outputs.count > 0
        env:
          BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
        run: |
          node scripts/visualize-pr-impact.mjs

      - name: Read impact report
        id: read-report
        if: steps.changed-files.outputs.count > 0
        run: |
          if [ -f pr-impact.md ]; then
            {
              echo 'report<<EOF'
              cat pr-impact.md
              echo 'EOF'
            } >> $GITHUB_OUTPUT

            # Extract summary for AI review
            CHANGED_COUNT="${{ steps.changed-files.outputs.count }}"
            CHANGED_FILES=$(cat pr-impact.md | sed -n '/## ë³€ê²½ëœ íŒŒì¼/,/## ì˜í–¥ë°›ëŠ” íŒŒì¼/p' | grep '^- `' | sed 's/^- `//;s/`$//')
            IMPACTED_FILES=$(cat pr-impact.md | sed -n '/## ì˜í–¥ë°›ëŠ” íŒŒì¼/,$p' | grep '^- `' | sed 's/^- `//;s/`$//')
            IMPACTED_COUNT=$(echo "$IMPACTED_FILES" | grep -v '^$' | wc -l | tr -d ' ')

            {
              echo 'impact_summary<<EOF'
              echo "ë³€ê²½ëœ íŒŒì¼ ìˆ˜: ${CHANGED_COUNT}ê°œ"
              echo "ì˜í–¥ë°›ëŠ” íŒŒì¼ ìˆ˜: ${IMPACTED_COUNT}ê°œ"
              echo ""
              echo "ë³€ê²½ëœ íŒŒì¼:"
              echo "$CHANGED_FILES"
              echo ""
              if [ ! -z "$IMPACTED_FILES" ]; then
                echo "ì˜í–¥ë°›ëŠ” íŒŒì¼:"
                echo "$IMPACTED_FILES"
              fi
              echo 'EOF'
            } >> $GITHUB_OUTPUT
          fi

      - name: Update PR description with impact info
        if: steps.changed-files.outputs.count > 0 && steps.read-report.outputs.impact_summary != ''
        uses: actions/github-script@v7
        env:
          IMPACT_SUMMARY: ${{ steps.read-report.outputs.impact_summary }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const impactSummary = process.env.IMPACT_SUMMARY;
            const body = pr.body || '';

            // Check if impact info already exists
            if (body.includes('## ğŸ“Š ì˜í–¥ ë²”ìœ„ ë¶„ì„')) {
              // Update existing section
              const newBody = body.replace(
                /## ğŸ“Š ì˜í–¥ ë²”ìœ„ ë¶„ì„[\s\S]*?(?=\n## |\n\[|$)/,
                `## ğŸ“Š ì˜í–¥ ë²”ìœ„ ë¶„ì„\n\n<details>\n<summary>ë³€ê²½ íŒŒì¼ ì˜í–¥ ë²”ìœ„</summary>\n\n\`\`\`\n${impactSummary}\n\`\`\`\n\n</details>\n\n`
              );
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                body: newBody,
              });
            } else {
              // Add new section
              const newBody = body.trim() + '\n\n## ğŸ“Š ì˜í–¥ ë²”ìœ„ ë¶„ì„\n\n<details>\n<summary>ë³€ê²½ íŒŒì¼ ì˜í–¥ ë²”ìœ„</summary>\n\n```\n' + impactSummary + '\n```\n\n</details>\n\n> ğŸ¤– **Gemini Code Assistì—ê²Œ**: ìœ„ ì˜í–¥ ë²”ìœ„ ë¶„ì„ì„ ì°¸ê³ í•˜ì—¬ íŠ¹íˆ ì˜í–¥ë°›ëŠ” íŒŒì¼ë“¤ì˜ í…ŒìŠ¤íŠ¸ ë²”ìœ„, ì ì¬ì  ìœ„í—˜, ê°œì„  ê¸°íšŒë¥¼ ì¤‘ì ì ìœ¼ë¡œ ê²€í† í•´ì£¼ì„¸ìš”.\n';

              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                body: newBody,
              });
            }

            core.info('PR description updated with impact analysis');

      - name: Find existing comment
        if: steps.changed-files.outputs.count > 0
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: 'PR ì˜í–¥ ë²”ìœ„ ë¶„ì„'

      - name: Create or update comment
        if: steps.changed-files.outputs.count > 0 && steps.read-report.outputs.report != ''
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: ${{ steps.read-report.outputs.report }}

      - name: No changes detected
        if: steps.changed-files.outputs.count == 0
        run: |
          echo "No TypeScript/JavaScript files changed in src directory. Skipping impact analysis."
