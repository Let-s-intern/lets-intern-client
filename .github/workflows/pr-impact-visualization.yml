name: PR Impact Visualization

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'src/**/*.ts'
      - 'src/**/*.tsx'
      - 'src/**/*.js'
      - 'src/**/*.jsx'

permissions:
  contents: read
  pull-requests: write

jobs:
  visualize-impact:
    name: Visualize PR Impact
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Get changed files
        id: changed-files
        run: |
          CHANGED_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | grep -E '\.(ts|tsx|js|jsx)$' | grep '^src/' || true)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          CHANGED_COUNT=$(echo "$CHANGED_FILES" | grep -v '^$' | wc -l | tr -d ' ')
          echo "count=$CHANGED_COUNT" >> $GITHUB_OUTPUT

      - name: Run impact analysis
        id: impact-analysis
        if: steps.changed-files.outputs.count > 0
        env:
          BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
        run: |
          node scripts/visualize-pr-impact.mjs

      - name: Read impact report
        id: read-report
        if: steps.changed-files.outputs.count > 0
        run: |
          if [ -f pr-impact.md ]; then
            {
              echo 'report<<EOF'
              cat pr-impact.md
              echo 'EOF'
            } >> $GITHUB_OUTPUT

            # Extract summary for AI review
            CHANGED_COUNT="${{ steps.changed-files.outputs.count }}"
            CHANGED_FILES=$(cat pr-impact.md | sed -n '/## ë³€ê²½ëœ íŒŒì¼/,/## ì˜í–¥ë°›ëŠ” íŒŒì¼/p' | grep '^- `' | sed 's/^- `//;s/`$//')
            IMPACTED_FILES=$(cat pr-impact.md | sed -n '/## ì˜í–¥ë°›ëŠ” íŒŒì¼/,$p' | grep '^- `' | sed 's/^- `//;s/`$//')
            IMPACTED_COUNT=$(echo "$IMPACTED_FILES" | grep -v '^$' | wc -l | tr -d ' ')

            {
              echo 'impact_summary<<EOF'
              echo "ë³€ê²½ëœ íŒŒì¼ ìˆ˜: ${CHANGED_COUNT}ê°œ"
              echo "ì˜í–¥ë°›ëŠ” íŒŒì¼ ìˆ˜: ${IMPACTED_COUNT}ê°œ"
              echo ""
              echo "ë³€ê²½ëœ íŒŒì¼:"
              echo "$CHANGED_FILES"
              echo ""
              if [ ! -z "$IMPACTED_FILES" ]; then
                echo "ì˜í–¥ë°›ëŠ” íŒŒì¼:"
                echo "$IMPACTED_FILES"
              fi
              echo 'EOF'
            } >> $GITHUB_OUTPUT
          fi

      - name: Generate AI-powered impact analysis
        if: steps.changed-files.outputs.count > 0 && steps.read-report.outputs.impact_summary != ''
        id: ai-analysis
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          IMPACT_SUMMARY: ${{ steps.read-report.outputs.impact_summary }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "âš ï¸ GEMINI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "ì˜í–¥ ë²”ìœ„ ì‹œê°í™”ë§Œ ì œê³µë©ë‹ˆë‹¤."
            echo "ai_advice=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Create Python script for API call
          cat > /tmp/call_gemini.py << 'PYTHON_SCRIPT'
          import os
          import json
          import urllib.request

          api_key = os.environ['GEMINI_API_KEY']
          impact_summary = os.environ['IMPACT_SUMMARY']
          pr_title = os.environ['PR_TITLE']

          prompt = f"""ë‹¹ì‹ ì€ 10ë…„ ê²½ë ¥ì˜ React/TypeScript ì‹œë‹ˆì–´ ê°œë°œìì…ë‹ˆë‹¤.
ì½”ë“œ ë¦¬ë·° ê²½í—˜ì´ í’ë¶€í•˜ë©°, ì‹¤ìš©ì ì´ê³  êµ¬ì²´ì ì¸ ì¡°ì–¸ì„ ì œê³µí•©ë‹ˆë‹¤.

=== Pull Request ì •ë³´ ===
PR ì œëª©: {pr_title}

=== ì˜í–¥ ë²”ìœ„ ë¶„ì„ ê²°ê³¼ ===
{impact_summary}

ìœ„ ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì•„ë˜ 4ê°€ì§€ ê´€ì ì—ì„œ ë§¤ìš° êµ¬ì²´ì ì´ê³  ì‹¤ìš©ì ì¸ ì¡°ì–¸ì„ í•œêµ­ì–´ë¡œ ì œê³µí•´ì£¼ì„¸ìš”.
ê° ì„¹ì…˜ë§ˆë‹¤ ìµœì†Œ 5-7ë¬¸ì¥ ì´ìƒ ì‘ì„±í•˜ê³ , ë°˜ë“œì‹œ êµ¬ì²´ì ì¸ íŒŒì¼ëª…ê³¼ ì½”ë“œ ìœ„ì¹˜ë¥¼ í¬í•¨í•´ì£¼ì„¸ìš”.

### ğŸ§ª í…ŒìŠ¤íŠ¸ ë²”ìœ„
ë³€ê²½ëœ ì»´í¬ë„ŒíŠ¸ê°€ ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” íŒŒì¼ë“¤ì„ ë¶„ì„í–ˆì„ ë•Œ, êµ¬ì²´ì ìœ¼ë¡œ ì–´ë–¤ ê¸°ëŠ¥ê³¼ í™”ë©´ì„ í…ŒìŠ¤íŠ¸í•´ì•¼ í•˜ëŠ”ì§€ ìƒì„¸íˆ ì„¤ëª…í•˜ì„¸ìš”.
- ì •í™•í•œ í˜ì´ì§€ ê²½ë¡œì™€ URLì„ ì–¸ê¸‰í•˜ì„¸ìš”
- í…ŒìŠ¤íŠ¸í•´ì•¼ í•  ì‚¬ìš©ì ì‹œë‚˜ë¦¬ì˜¤ 3-4ê°€ì§€ë¥¼ ë‹¨ê³„ë³„ë¡œ ì„¤ëª…í•˜ì„¸ìš”
- í™•ì¸í•´ì•¼ í•  Props ì¡°í•©ê³¼ ìƒíƒœ ë³€í™”ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì–¸ê¸‰í•˜ì„¸ìš”
- ì—£ì§€ ì¼€ì´ìŠ¤ë¥¼ ìµœì†Œ 3ê°€ì§€ ì´ìƒ ì œì‹œí•˜ì„¸ìš”

### âš ï¸ ì ì¬ì  ìœ„í—˜
ê³µí†µ ì»´í¬ë„ŒíŠ¸ ë³€ê²½ì´ ì¼ìœ¼í‚¬ ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ ìœ„í—˜ì„ íŒŒì¼ëª…ê³¼ ì½”ë“œ ìœ„ì¹˜ë¥¼ í¬í•¨í•´ì„œ ì„¤ëª…í•˜ì„¸ìš”.
- ê¸°ì¡´ ì½”ë“œì™€ì˜ í˜¸í™˜ì„± ë¬¸ì œ (êµ¬ì²´ì ì¸ íŒŒì¼ëª…ê³¼ ë¼ì¸ ë²ˆí˜¸)
- ì„±ëŠ¥ ì €í•˜ ê°€ëŠ¥ì„± (ì–´ë–¤ í•¨ìˆ˜, ì–´ë–¤ ìƒí™©ì—ì„œ)
- íƒ€ì… ì•ˆì •ì„± ì´ìŠˆ (ì–´ë–¤ íƒ€ì…, ì–´ë–¤ Props)
- íŠ¹ì • ë¸Œë¼ìš°ì €ë‚˜ í™˜ê²½ì—ì„œì˜ ë¬¸ì œ

### ğŸ”§ ê°œì„  ì œì•ˆ
ì´ë²ˆ ë³€ê²½ì„ ê¸°íšŒë¡œ í•¨ê»˜ ê°œì„ í•˜ë©´ ì¢‹ì„ ë¶€ë¶„ì„ êµ¬ì²´ì ì¸ ì½”ë“œì™€ í•¨ê»˜ ì œì•ˆí•˜ì„¸ìš”.
- ì¤‘ë³µ ì½”ë“œ ìœ„ì¹˜ì™€ ê°œì„  ë°©ë²• (íŒŒì¼ëª…, ë¼ì¸ ë²ˆí˜¸)
- íƒ€ì… ì•ˆì •ì„± ê°•í™” ë°©ë²•
- ì„±ëŠ¥ ìµœì í™” ë°©ë²• (ì–´ë–¤ í•¨ìˆ˜ì— useMemo/useCallback ì ìš©)
- ì½”ë“œ ê°€ë…ì„± ê°œì„ 

### ğŸ“ ë¬¸ì„œí™”
ì½”ë“œ ë³€ê²½ì— ë”°ë¼ ì—…ë°ì´íŠ¸ê°€ í•„ìš”í•œ ë¬¸ì„œë¥¼ êµ¬ì²´ì ì¸ ê²½ë¡œì™€ ë‚´ìš©ì„ í¬í•¨í•´ì„œ ë‚˜ì—´í•˜ì„¸ìš”.
- ì—…ë°ì´íŠ¸í•´ì•¼ í•  READMEë‚˜ ë¬¸ì„œ íŒŒì¼
- ì¶”ê°€í•´ì•¼ í•  JSDoc ìœ„ì¹˜ (íŒŒì¼ëª…ê³¼ í•¨ìˆ˜ëª…)
- ì‘ì„±í•´ì•¼ í•  ì‚¬ìš© ì˜ˆì‹œë‚˜ ì½”ë“œ ìŠ¤ë‹ˆí«

ê° ì„¹ì…˜ì„ ìµœì†Œ 5-7ë¬¸ì¥ ì´ìƒìœ¼ë¡œ ì‘ì„±í•˜ê³ , ì¶”ìƒì ì¸ ì¡°ì–¸ë³´ë‹¤ëŠ” ì‹¤ì œë¡œ í™•ì¸í•˜ê³  ìˆ˜ì •í•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ ë‚´ìš©ì„ í¬í•¨í•´ì£¼ì„¸ìš”."""

          data = {
              "contents": [{
                  "parts": [{"text": prompt}]
              }],
              "generationConfig": {
                  "temperature": 0.7,
                  "maxOutputTokens": 4096
              }
          }

          url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key={api_key}"
          req = urllib.request.Request(url, json.dumps(data).encode('utf-8'), {'Content-Type': 'application/json'})

          try:
              with urllib.request.urlopen(req) as response:
                  result = json.loads(response.read().decode('utf-8'))
                  if 'candidates' in result and len(result['candidates']) > 0:
                      print(result['candidates'][0]['content']['parts'][0]['text'])
                  else:
                      print(f"DEBUG: No candidates in response: {json.dumps(result)}", file=os.sys.stderr)
                      print("")
          except urllib.error.HTTPError as e:
              error_body = e.read().decode('utf-8')
              print(f"HTTP Error {e.code}: {error_body}", file=os.sys.stderr)
              print("")
          except Exception as e:
              print(f"Error: {type(e).__name__}: {e}", file=os.sys.stderr)
              print("")
          PYTHON_SCRIPT

          # Run Python script
          ADVICE=$(python3 /tmp/call_gemini.py 2>&1)

          echo "DEBUG: ADVICE output:"
          echo "$ADVICE"

          if [ -z "$ADVICE" ] || [[ "$ADVICE" == *"Error:"* ]] || [[ "$ADVICE" == *"HTTP Error"* ]]; then
            echo "âŒ AI ì¡°ì–¸ ìƒì„± ì‹¤íŒ¨"
            echo "ì—ëŸ¬ ë‚´ìš©: $ADVICE"
            echo "ai_advice=" >> $GITHUB_OUTPUT
          else
            echo "âœ… AI ì¡°ì–¸ ìƒì„± ì„±ê³µ"
            {
              echo 'ai_advice<<EOF'
              echo "$ADVICE"
              echo 'EOF'
            } >> $GITHUB_OUTPUT
          fi

          rm -f /tmp/call_gemini.py

      - name: Find existing comment
        if: steps.changed-files.outputs.count > 0
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: 'PR ì˜í–¥ ë²”ìœ„ ë¶„ì„'

      - name: Create or update comment
        if: steps.changed-files.outputs.count > 0 && steps.read-report.outputs.report != ''
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: |
            ${{ steps.read-report.outputs.report }}
            ${{ steps.ai-analysis.outputs.ai_advice != '' && format('
            ---

            ## ğŸ¤– AI ê¸°ë°˜ ì˜í–¥ ë¶„ì„ ë° ì¡°ì–¸

            {0}

            *ì´ ì¡°ì–¸ì€ Gemini APIë¥¼ í†µí•´ ì˜í–¥ ë²”ìœ„ ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*', steps.ai-analysis.outputs.ai_advice) || '' }}

      - name: No changes detected
        if: steps.changed-files.outputs.count == 0
        run: |
          echo "No TypeScript/JavaScript files changed in src directory. Skipping impact analysis."
